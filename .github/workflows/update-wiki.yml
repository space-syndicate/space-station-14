name: Update Wiki

on:
  workflow_dispatch:
  push:
    branches: [ master, jsondump ]
    paths:
      - '.github/workflows/update-wiki.yml'
      - 'Content.Shared/**'
      - 'Content.Server/**'
      - 'Content.Client/**'
      - 'Resources/**'
      - 'RobustToolbox/'

jobs:
  update-wiki:
    name: Build and Publish JSON blobs to wiki
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Master
      uses: actions/checkout@v4.2.2

    - name: Setup Submodule
      run: |
        git submodule update --init --recursive

    - name: Pull Engine Updates
      uses: space-wizards/submodule-dependency@v0.1.5

    - name: Update Engine Submodules
      run: |
        cd RobustToolbox/
        git submodule update --init --recursive

    - name: Setup .NET Core
      uses: actions/setup-dotnet@v4.1.0
      with:
        dotnet-version: 9.0.x

    - name: Install Dependencies
      run: dotnet restore

    - name: Build Project
      run: dotnet build --configuration Release --no-restore /p:WarningsAsErrors=nullable /m

    - name: Generate JSON blobs for prototypes
      run: dotnet ./bin/Content.Server/Content.Server.dll --cvar autogen.destination_file=prototypes.json
      continue-on-error: true

    # Проходит по всем JSON-файлам в директории BASE и загружает каждый файл как страницу в MediaWiki.
    # Имя страницы формируется из относительного пути к файлу.
    - name: Upload JSON files to wiki
      shell: bash
      run: |
        set -euo pipefail

        BASE="./bin/Content.Server/data"
        ROOT="${{ secrets.WIKI_PAGE_ROOT }}"
        API="${{ secrets.WIKI_ROOT_URL }}/api.php"
        USER="${{ secrets.WIKI_BOT_USER }}"
        PASS="${{ secrets.WIKI_BOT_PASS }}"

        API="$(printf "%s" "$API" | tr -d '\r\n' | sed 's/[[:space:]]*$//')"
        USER="$(printf "%s" "$USER" | tr -d '\r\n')"
        PASS="$(printf "%s" "$PASS" | tr -d '\r\n')"
        ROOT="$(printf "%s" "$ROOT" | tr -d '\r\n' | sed 's/[[:space:]]*$//')"

        cookiejar="$(mktemp)"
        trap 'rm -f "$cookiejar"' EXIT

        login_token=$(curl -sS -c "$cookiejar" --data "action=query&meta=tokens&type=login&format=json" "$API" | jq -r '.query.tokens.logintoken')
        curl -sS -c "$cookiejar" -b "$cookiejar" \
          --data-urlencode "action=login" \
          --data-urlencode "lgname=$USER" \
          --data-urlencode "lgpassword=$PASS" \
          --data-urlencode "lgtoken=$login_token" \
          --data-urlencode "format=json" \
          "$API" > /dev/null

        find "$BASE" -type f -name '*.json' | while IFS= read -r file; do
          rel="${file#$BASE/}"
          rel="$(printf "%s" "$rel" | tr -d '\r\n' | sed 's/:/_/g')"
          page="$ROOT/$rel"
          echo "Uploading $rel → $page"

          token=$(curl -sS -b "$cookiejar" --data "action=query&meta=tokens&format=json" "$API" | jq -r '.query.tokens.csrftoken')

          curl -sS -b "$cookiejar" \
            --data-urlencode "action=edit" \
            --data-urlencode "title=$page" \
            --data-urlencode "summary=Update $rel via GitHub Actions" \
            --data-urlencode "text@${file}" \
            --data-urlencode "token=$token" \
            --data-urlencode "format=json" \
            "$API" | jq -r '.'
        done
